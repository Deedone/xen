env:
    global:
        # The next declaration is the encrypted COVERITY_SCAN_TOKEN, created
        #   via the "travis encrypt" command using the project repo's public key
        - secure: "j8Ogv0C6y44xoysVaEqiPU78qtKfv5mqFS9YcPldEGOa1CUqV5s7zACozqcqA/M6YCVbLqMA5twg1RCeSad7m4KaP1J/z7g4/UsdZ1XHiNthSCiE9M2bcyqcPqao7LlqbBfFa34WwEtk0HOCvap7NR5sAjp2Y1Nd+OtMBJSTmtvEQ/tJVme4uzBybV0paE0FmF5zNlaexXh93qqy0yksxWV5gScM503XgO/YaFV0HcXyeO0XIadbtBjsi427lCpi8SnOb6sIeoiaF9P8VyCwMwDH2rXlU5YsqjpI5oNHImJEozuoi8I/K3icj67xUiv83cAgoAbSq7MCAEM+cQIGP8RJWO9/W5OZL2eUcJ/swCzw9NJe4e+lD+ij6k/5n5wEqSTSmAUxORBduGNJon3VsXhvu+kbdFEodOaDpSRI+r57sgM47T1DfPmxP19xu7Jr7Xanj9nvFNJuWbcz8k5Zp0ox/cpOv1HDG3q1wwpq/W4050OLy5yYRVLt8GQHgKaqXxHbi2dpclizd8FzkzxMJuD+HOQdCghoygnZhWkzsinKsr++JO2uNk0IZZaHZPfSZ7FJq936+OyNYFF/bK4SHGWHQ2hINzK1Z2kBxVr3PttdlHKilINpPUpaPArb1IYbadEEa23RiUCtnzhVHva5gsBhoiPMpWgApwTCRBHu0x8="

language: c

os:
    - linux

dist: trusty
sudo: required

branches:
    only:
        - coverity-scan

before_install:
    - echo -n | openssl s_client -connect https://scan.coverity.com:443 | sed -ne '/-BEGIN CERTIFICATE-/,/-END CERTIFICATE-/p' | sudo tee -a /etc/ssl/certs/ca-
    - wget -c http://releases.linaro.org/components/toolchain/binaries/latest-7/aarch64-linux-gnu/gcc-linaro-7.4.1-2019.02-x86_64_aarch64-linux-gnu.tar.xz
    - tar xf gcc-linaro-7.4.1-2019.02-x86_64_aarch64-linux-gnu.tar.xz
    - export PATH=$PWD/gcc-linaro-7.4.1-2019.02-x86_64_aarch64-linux-gnu/bin/:$PATH
    - aarch64-linux-gnu-gcc --version
    # exporting the variable to be used by make utility
    - export CROSS_COMPILE=aarch64-linux-gnu-
    - export NUMCPUS=`nproc`
    - export XEN_TARGET_ARCH=arm64

addons:
    apt:
        update: true
        sources:
            - ubuntu-toolchain-r-test
            - llvm-toolchain-trusty-6.0
        packages:
            - zlib1g-dev
            - libncurses5-dev
            - libssl-dev
            - python-dev
            - xorg-dev
            - uuid-dev
            - libyajl-dev
            - libaio-dev
            - libglib2.0-dev
            - libpixman-1-dev
            - pkg-config
            - flex
            - bison
            - gettext
            - acpica-tools
            - bin86
            - bcc
            - libc6-dev-i386
            - libnl-3-dev
            - ocaml-nox
            - libfindlib-ocaml-dev
            - transfig
            - pandoc
            - gcc-7
            - g++-7
            - clang-6.0
    coverity_scan:
        project:
            name: "xen-troops/xen"
            description: "Build submitted via Travis CI"
        notification_email: joculator@gmail.com
        build_command_prepend: "cov-configure --comptype gcc --compiler aarch64-linux-gnu-gcc --template"
        build_command: "make xen -j$NUMCPUS XEN_TARGET_ARCH=$XEN_TARGET_ARCH CROSS_COMPILE=$CROSS_COMPILE XSM_ENABLE=y CONFIG_HAS_SCIF=y CONFIG_DEBUG=y CONFIG_EARLY_PRINTK=rcar3 CONFIG_QEMU_XEN=n"
        branch_pattern: coverity-scan

script:
    - if [ "${COVERITY_SCAN_BRANCH}" != 1 ]; then make xen -j$NUMCPUS XEN_TARGET_ARCH=$XEN_TARGET_ARCH CROSS_COMPILE=$CROSS_COMPILE XSM_ENABLE=y CONFIG_HAS_SCIF=y CONFIG_DEBUG=y CONFIG_EARLY_PRINTK=rcar3 CONFIG_QEMU_XEN=n; fi
